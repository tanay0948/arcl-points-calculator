<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ARCL Points </title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
  #chatContainer::-webkit-scrollbar {
    width: 6px;
  }
  #chatContainer::-webkit-scrollbar-thumb {
    background-color: #9ca3af;
    border-radius: 3px;
  }
</style>

</head>

<body class="bg-gradient-to-br from-indigo-100 to-blue-50 min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

  <!-- Header -->
  <header class="text-center mt-6 mb-4">
    <h1 class="text-3xl font-bold text-blue-800">🏏 ARCL Points Assistant</h1>
    <p class="text-gray-600">Understand rules • Plan smart • Track points live</p>
  </header>

  <!-- Navigation Tabs -->
  <div class="flex flex-wrap justify-center gap-3 mb-4">
  <button id="tabRules" class="tab px-4 py-2 bg-white border border-blue-600 text-blue-700 rounded-lg font-semibold">
    Rules
  </button>
  <button id="tabLive" class="tab px-4 py-2 bg-white border border-blue-600 text-blue-700 rounded-lg font-semibold">
    ARCL Points AI
  </button>
</div>

  <!-- ========== RULES TAB ========== -->
 <!-- ========== RULES TAB ========== -->
<section id="rulesCard" class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-3xl overflow-y-auto max-h-[75vh]">
  <h2 class="text-2xl font-bold text-blue-800 mb-4">📘 ARCL Points System Explained</h2>

  <p class="text-gray-700 mb-3">
    Each match in ARCL has a total of <strong>30 points</strong> shared between both teams.
  </p>

  <div class="space-y-5 text-gray-800">

    <!-- Points Split -->
    <div>
      <h3 class="font-semibold text-blue-700 text-lg">⚖️ How the 30 Points Are Split</h3>
      <ul class="list-disc ml-6 space-y-1">
        <li><strong>20 points</strong> always go to the winning team.</li>
        <li>The remaining <strong>10 points</strong> are “bonus points” for batting and bowling performance.</li>
        <li><strong>Winning team</strong> = 20 + (10 − opponent’s bonus).</li>
        <li><strong>Losing team</strong> = only their earned bonus (0–10).</li>
        <li><strong>Tie</strong> = both teams get 15 each, no bonus.</li>
      </ul>

      <table class="w-full text-sm border mt-3 text-center">
        <thead class="bg-blue-100 font-semibold">
          <tr><th>Result</th><th>What You Get</th></tr>
        </thead>
        <tbody>
          <tr><td>Win</td><td>20 + (10 − opponent’s bonus)</td></tr>
          <tr><td>Lose</td><td>Your own bonus (0–10)</td></tr>
          <tr><td>Tie</td><td>15 each</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Bonus Points -->
    <div>
      <h3 class="font-semibold text-blue-700 text-lg">🎯 How Bonus Points Are Given</h3>
      <p class="mb-1">Two types of bonus points for the losing team:</p>
      <ol class="list-decimal ml-6">
        <li><strong>Batting Points</strong> – up to 5 based on score or run rate.</li>
        <li><strong>Bowling Points</strong> – up to 5 based on wickets taken.</li>
      </ol>
    </div>

    <!-- Batting Points -->
    <div>
      <h3 class="font-semibold text-blue-700 text-lg">1️⃣ Batting Points (max 5)</h3>
      <p>If you lose, batting points depend on how close your performance was to the winner’s.</p>

      <h4 class="font-semibold mt-2">Case A – You Batted Second (Chasing)</h4>
      <table class="w-full border text-sm text-center mt-2">
        <thead class="bg-blue-100"><tr><th>Points</th><th>Your Score vs Winner’s Score</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>&gt;50% and ≤60%</td></tr>
          <tr><td>2</td><td>&gt;60% and ≤70%</td></tr>
          <tr><td>3</td><td>&gt;70% and ≤80%</td></tr>
          <tr><td>4</td><td>&gt;80% and ≤90%</td></tr>
          <tr><td>5</td><td>&gt;90%</td></tr>
        </tbody>
      </table>

      <div class="bg-gray-50 rounded-lg p-3 mt-2 text-sm">
        <strong>Example:</strong><br>
        Opponent made 160.<br>
        You made 145 (90.6%) → 5 batting points even though you lost.
      </div>

      <h4 class="font-semibold mt-4">Case B – You Batted First (They Chased)</h4>
      <table class="w-full border text-sm text-center mt-2">
        <thead class="bg-blue-100"><tr><th>Points</th><th>Your Run Rate vs Winner’s Run Rate</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>&gt;50% and ≤60%</td></tr>
          <tr><td>2</td><td>&gt;60% and ≤70%</td></tr>
          <tr><td>3</td><td>&gt;70% and ≤80%</td></tr>
          <tr><td>4</td><td>&gt;80% and ≤90%</td></tr>
          <tr><td>5</td><td>&gt;90%</td></tr>
        </tbody>
      </table>

      <div class="bg-gray-50 rounded-lg p-3 mt-2 text-sm">
        <strong>Example:</strong><br>
        You made 140 in 16 overs = 8.75 RPO.<br>
        Opponent chased 141 in 14 overs = 10.07 RPO.<br>
        8.75 / 10.07 = 86.9% → 4 batting points.
      </div>
    </div>

    <!-- Bowling Points -->
    <div>
      <h3 class="font-semibold text-blue-700 text-lg">2️⃣ Bowling Points (max 5)</h3>
      <p>Given based on how many wickets your team took (only the losing side earns these).</p>

      <table class="w-full border text-sm text-center mt-2">
        <thead class="bg-blue-100"><tr><th>Wickets Taken</th><th>Bowling Points</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>1</td></tr>
          <tr><td>3</td><td>2</td></tr>
          <tr><td>5</td><td>3</td></tr>
          <tr><td>6</td><td>4</td></tr>
          <tr><td>7+</td><td>5</td></tr>
        </tbody>
      </table>

      <div class="bg-gray-50 rounded-lg p-3 mt-2 text-sm">
        <strong>Example:</strong><br>
        You took 6 wickets while losing → 4 bowling points.
      </div>
    </div>

    <!-- Detailed Examples -->
    <div>
      <h3 class="font-semibold text-blue-700 text-lg">💡 Detailed Match Examples</h3>

      <div class="bg-green-50 p-3 rounded-lg text-sm mb-3">
        <strong>Example 1 — You Lost While Chasing</strong><br>
        Opponent made 160.<br>
        You made 145 (91%) and took 6 wickets.<br><br>
        ➤ Batting = 5 (scored >90%)<br>
        ➤ Bowling = 4 (took 6 wickets)<br>
        ➤ Your Total = 9 bonus points<br>
        ➤ Opponent = 20 + (10 − 9) = 21 points<br><br>
        ✅ <em>Result:</em> You 9 pts • Opponent 21 pts
      </div>

      <div class="bg-green-50 p-3 rounded-lg text-sm mb-3">
        <strong>Example 2 — You Won Comfortably</strong><br>
        You scored 150 and bowled out opponent for 100.<br>
        Opponent’s percentage = 100 / 150 = 66.6 % → 2 batting points.<br>
        They took only 3 wickets → 2 bowling points.<br>
        Opponent’s total = 4 bonus points.<br>
        ➤ You get 20 + (10 − 4) = 26 points.<br><br>
        ✅ <em>Result:</em> You 26 pts • Opponent 4 pts
      </div>

      <div class="bg-green-50 p-3 rounded-lg text-sm mb-3">
        <strong>Example 3 — Tie Game</strong><br>
        Both teams score 135 runs.<br>
        No bonus calculation — both teams get 15 points each.<br>
        ✅ <em>Result:</em> 15 pts each
      </div>

      <div class="bg-green-50 p-3 rounded-lg text-sm mb-3">
        <strong>Example 4 — You Batted First and Lost</strong><br>
        You made 140 in 16 overs (8.75 rpo). Opponent chased 141 in 15 overs (9.4 rpo).<br>
        Your run-rate ratio = 8.75 / 9.4 = 93.1 % → 5 batting points.<br>
        You took 5 wickets → 3 bowling points.<br>
        ➤ Total = 8 points out of 10.<br>
        ➤ Opponent = 20 + (10 − 8) = 22 points.<br>
        ✅ <em>Result:</em> You 8 pts • Opponent 22 pts
      </div>

      <div class="bg-green-50 p-3 rounded-lg text-sm mb-3">
        <strong>Example 5 — You Lost Heavily</strong><br>
        Opponent made 180. You managed 100 runs (55 %) and took 2 wickets.<br>
        ➤ Batting = 1 point (>50 %)<br>
        ➤ Bowling = 1 point (2 wickets ≈ between 1 and 3)<br>
        ➤ Total = 2 points.<br>
        ➤ Opponent = 20 + (10 − 2) = 28 points.<br>
        ✅ <em>Result:</em> You 2 pts • Opponent 28 pts
      </div>

      <div class="bg-green-50 p-3 rounded-lg text-sm">
        <strong>Example 6 — Low-Scoring Thriller</strong><br>
        You batted first: 85 all out. Opponent chased in 15 overs for 86/7.<br>
        ➤ Your bowling = 7 wickets → 5 points.<br>
        ➤ Your batting = 85 / 86 ≈ 99 % → 5 points.<br>
        Total = 10 points (max possible while losing).<br>
        ➤ Opponent = 20 + (10 − 10) = 20 points.<br>
        ✅ <em>Result:</em> You 10 pts • Opponent 20 pts
      </div>
    </div>

    <!-- Quick Recap -->
    <div>
      <h3 class="font-semibold text-blue-700 text-lg">🔢 Quick Recap</h3>
      <table class="w-full border text-sm text-center mt-2">
        <thead class="bg-blue-100"><tr><th>Situation</th><th>Points</th></tr></thead>
        <tbody>
          <tr><td>Win</td><td>20 + (10 − opponent’s bonus)</td></tr>
          <tr><td>Lose</td><td>0 – 10 (batting + bowling)</td></tr>
          <tr><td>Tie</td><td>15 each</td></tr>
          <tr><td>Max per match</td><td>30 points shared</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</section>

  <!-- ========== LIVE MATCH TAB ========== -->
  <!-- ========== LIVE MATCH CHAT TAB ========== -->
<section id="liveCard" class="hidden bg-white rounded-2xl shadow-lg p-6 w-full max-w-lg sm:max-w-xl lg:max-w-3xl">
  <h2 class="text-xl font-bold mb-4 text-green-700">💬 ARCL Points Chat Assistant</h2>

  <div id="chatContainer" class="h-96 overflow-y-auto border rounded-lg p-3 bg-gray-50 space-y-3 mb-4">
    <div class="text-gray-500 text-sm text-center mt-10">
      👋 Hi! I’m your ARCL Points Assistant.<br />
      Ask me about your match situation, and I’ll analyze it for points and strategy.
    </div>
  </div>

  <div class="flex space-x-2">
    <input id="chatInput" type="text"
  class="flex-grow border p-2 rounded-lg text-sm sm:text-base"
  placeholder="Describe your match situation..." />
<button onclick="sendMessage()" 
  class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 rounded-lg text-sm sm:text-base">
  Send
</button>

  </div>
</section>

  

  <footer class="mt-6 text-gray-500 text-sm">© 2025 ARCL Helper (Unofficial)</footer>

  <script>
    // ======== ARCL Chat Assistant ========

const chatHistory = []; // Store last 5 messages

async function sendMessage() {
  const input = document.getElementById("chatInput");
  const chatBox = document.getElementById("chatContainer");
  const userText = input.value.trim();
  if (!userText) return;

  // Add user message to chat
  appendMessage("user", userText);
  input.value = "";

  // Maintain last 5 messages (rolling context)
  // chatHistory.push({ role: "user", content: userText });
  // if (chatHistory.length > 5) chatHistory.shift();

  // // Prepare conversation context
  // const combinedContext = chatHistory.map(m => `${m.role === "user" ? "User" : "Assistant"}: ${m.content}`).join("\n");

  appendMessage("assistant", "⏳ Thinking...");

  try {
    const response = await fetch("https://arcl-points-api.vercel.app/api/suggest", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-proxy-key": "ARCL1234"
      },
      body: JSON.stringify({ situation: userText })
    });

    const data = await response.json();
    const reply = data.suggestions || "No response received.";

    // Replace last "Thinking..." message
    chatBox.lastChild.remove();
    appendMessage("assistant", reply);

    // // Add assistant response to history
    // chatHistory.push({ role: "assistant", content: reply });
    // if (chatHistory.length > 5) chatHistory.shift();

  } catch (err) {
    chatBox.lastChild.remove();
    appendMessage("assistant", "❌ Error fetching reply. Please try again later.");
    console.error("Chat API error:", err);
  }
}

function appendMessage(sender, text) {
  const chatBox = document.getElementById("chatContainer");
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("p-2", "rounded-lg", "whitespace-pre-line");

  if (sender === "user") {
    msgDiv.classList.add("bg-blue-100", "text-blue-800", "self-end");
    msgDiv.textContent = `🧍‍♂️ You: ${text}`;
  } else {
    msgDiv.classList.add("bg-green-50", "text-gray-800");
    msgDiv.innerHTML = marked.parse(text); // ✅ converts markdown → HTML
  }

  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

    // ======== Tab Logic ========
    const tabs = {
      rules: document.getElementById("tabRules"),
      live: document.getElementById("tabLive")
    };
    const sections = {
      rules: document.getElementById("rulesCard"),
      live: document.getElementById("liveCard")
    };
    Object.keys(tabs).forEach(id => {
      tabs[id].onclick = () => {
        Object.keys(tabs).forEach(k => {
          tabs[k].classList.remove("bg-blue-600","text-white");
          tabs[k].classList.add("bg-white","text-blue-700","border");
          sections[k].classList.add("hidden");
        });
        tabs[id].classList.remove("bg-white","text-blue-700");
        tabs[id].classList.add("bg-blue-600","text-white");
        sections[id].classList.remove("hidden");
      };
    });

    // ======== Helpers ========
    const bowlingPoints = w => w >= 7 ? 5 : w >= 6 ? 4 : w >= 5 ? 3 : w >= 3 ? 2 : w >= 1 ? 1 : 0;
    const thresholds = [0.5,0.6,0.7,0.8,0.9];

    // ======== Completed Match ========
    function calculateCompleted() {
      const s = id => parseFloat(document.getElementById(id).value);
      const yourScore=s("c_yourScore"), yourOvers=s("c_yourOvers"), oppScore=s("c_oppScore"), oppOvers=s("c_oppOvers"),
            yourWkts=s("c_yourWkts"), oppWkts=s("c_oppWkts");
      const result=document.getElementById("c_result").value, batFirst=document.getElementById("c_batFirst").value==="us";
      if([yourScore,oppScore].some(isNaN)) return alert("Please fill in all fields.");

      function batPts(bFirst, ys, yo, os, oo, won) {
        if(won) return 0;
        if(bFirst){const rate=(ys/yo)/(os/oo);return thresholds.filter(t=>rate>t).length;}
        else{const pct=ys/os;return thresholds.filter(t=>pct>t).length;}
      }

      const youWon=result==="win", tie=result==="tie", youLost=result==="lose";
      let yourBat=0,yourBowl=0,oppBat=0,oppBowl=0;

      if(youLost){
        yourBat=batPts(batFirst,yourScore,yourOvers,oppScore,oppOvers,false);
        yourBowl=bowlingPoints(yourWkts);
        oppBat=batPts(!batFirst,oppScore,oppOvers,yourScore,yourOvers,true);
        oppBowl=bowlingPoints(oppWkts);
      }else if(youWon){
        oppBat=batPts(!batFirst,oppScore,oppOvers,yourScore,yourOvers,false);
        oppBowl=bowlingPoints(oppWkts);
      }

      let yourTotal=0,oppTotal=0;
      if(tie) yourTotal=oppTotal=15;
      else if(youWon){yourTotal=20+(10-(oppBat+oppBowl));oppTotal=oppBat+oppBowl;}
      else if(youLost){yourTotal=yourBat+yourBowl;oppTotal=20+(10-yourTotal);}

      document.getElementById("c_yourPoints").innerText=`Your Total: ${yourTotal}`;
      document.getElementById("c_oppPoints").innerText=`Opponent Total: ${oppTotal}`;
      document.getElementById("c_breakdown").innerText=`You(Bat ${yourBat}, Bowl ${yourBowl}) | Opponent(Bat ${oppBat}, Bowl ${oppBowl})`;
      document.getElementById("completedResult").classList.remove("hidden");
    }

    // ======== Live Match  ========
    function suggestLive() {
      const yourScore=parseFloat(document.getElementById("l_yourScore").value),
            yourOvers=parseFloat(document.getElementById("l_yourOvers").value),
            oppScore=parseFloat(document.getElementById("l_oppScore").value),
            oppOvers=parseFloat(document.getElementById("l_oppOvers").value),
            wkts=parseFloat(document.getElementById("l_wkts").value),
            batFirst=document.getElementById("l_batFirst").value==="us";
      if([yourScore,yourOvers,oppScore,oppOvers].some(isNaN)) return alert("Please fill in all required fields.");

      const sgs=[];
      if(batFirst){
        const rr=(yourScore/yourOvers)/(oppScore/oppOvers);
        const pts=thresholds.filter(t=>rr>t).length;
        const next=thresholds[pts];
        sgs.push(`📊 Current run rate ratio: ${(rr*100).toFixed(1)}%. Batting points now: ${pts}.`);
        if(pts<5){
          const needRate=next*(oppScore/oppOvers);
          const needRuns=Math.ceil(needRate*yourOvers-yourScore);
          sgs.push(`🏏 Need ≈ ${needRuns} more runs to cross ${(next*100)}% run rate → +1 batting point.`);
        } else sgs.push("✅ You’re on track for full batting points!");
      } else {
        const pct=yourScore/oppScore;
        const pts=thresholds.filter(t=>pct>t).length;
        const next=thresholds[pts];
        sgs.push(`📊 Current target progress: ${(pct*100).toFixed(1)}%. Batting points now: ${pts}.`);
        if(pts<5){
          const needRuns=Math.ceil(next*oppScore-yourScore);
          sgs.push(`🏏 Need ${needRuns} more runs to cross ${(next*100)}% target → +1 batting point.`);
        } else sgs.push("✅ You’re on track for full batting points!");
      }

      const bowl=bowlingPoints(wkts);
      if(bowl<5){
        const milestones=[1,3,5,6,7];
        const next=milestones.find(m=>m>wkts);
        sgs.push(`🎯 Take ${next-wkts} more wicket${next-wkts>1?"s":""} to reach ${bowl+1} bowling point(s).`);
      } else sgs.push("🔥 You’ve maxed out bowling points!");

      sgs.push(batFirst
        ? "🔍 Strategy: Accelerate scoring between overs 12–16 to push RR 90%+, then attack with power hitters."
        : "🔍 Strategy: Focus on partnerships. If 10–20 runs behind target %, increase strike rotation and boundary rate."
      );

      document.getElementById("l_suggestions").innerHTML=sgs.map(s=>`<div class='p-2 bg-green-50 rounded-lg'>${s}</div>`).join("");
      document.getElementById("liveResult").classList.remove("hidden");
    }
  </script>
</body>
</html>
